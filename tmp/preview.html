<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tex-Machina | Pastel Graph</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            /* Modern Pastel Palette */
            --bg: #ffffff;
            --fg: #444444;
            --panel: #fcfcfc;
            --border: #f0f0f0;
            --accent: #74c0fc;
            --node-sec: #ffc9c9; /* Pastel Red/Peach */
            --node-eq: #a5d8ff;  /* Pastel Blue */
            --node-fig: #b2f2bb; /* Pastel Green */
            --edge: #e0e0e0;
            --font: "Inter", -apple-system, system-ui, sans-serif;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #1e1e1e;
                --fg: #bbbbbb;
                --panel: #252526;
                --border: #333333;
                --edge: #444444;
                --node-sec: #ff8787;
                --node-eq: #4dabf7;
                --node-fig: #69db7c;
            }
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg); color: var(--fg);
            font-family: var(--font);
            overflow: hidden;
        }

        #layout { display: flex; flex-direction: column; width: 100%; height: 100vh; }

        #header {
            height: 48px; display: flex; align-items: center; padding: 0 20px;
            background: var(--panel); border-bottom: 1px solid var(--border); z-index: 100;
        }

        #title { font-weight: 500; font-size: 11px; letter-spacing: 1.5px; opacity: 0.6; text-transform: uppercase; }
        
        #viz-outer { flex-grow: 1; position: relative; width: 100%; }
        #viz { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        #inspector {
            position: absolute; top: 20px; right: 20px; width: 300px;
            background: var(--panel); border: 1px solid var(--border);
            border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none; padding: 20px; z-index: 200;
        }

        .math-preview {
            background: var(--bg); border: 1px solid var(--border);
            padding: 15px; margin: 15px 0; border-radius: 6px; text-align: center;
        }

        .btn {
            background: var(--panel); border: 1px solid var(--border); color: var(--fg);
            padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 11px;
            margin-left: 8px; transition: all 0.2s;
        }
        .btn:hover { border-color: var(--accent); background: var(--bg); }

        #legend {
            position: absolute; bottom: 20px; left: 20px;
            display: flex; gap: 20px; font-size: 11px; opacity: 0.7; pointer-events: none;
        }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }
    </style>
</head>
<body>
    <div id="layout">
        <div id="header">
            <div id="title">Tex-Machina Dependency Graph</div>
            <div style="flex-grow: 1"></div>
            <button class="btn" onclick="network.fit({animation:true})">Fit View</button>
            <button class="btn" onclick="addDynamicNode()">+ Simulate Update</button>
        </div>
        
        <div id="viz-outer">
            <div id="viz"></div>
            <div id="legend">
                <div class="legend-item"><span class="dot" style="background:var(--node-sec)"></span> Section</div>
                <div class="legend-item"><span class="dot" style="background:var(--node-eq)"></span> Equation</div>
                <div class="legend-item"><span class="dot" style="background:var(--node-fig)"></span> Figure</div>
            </div>
        </div>

        <div id="inspector">
            <div id="ins-label" style="font-weight: 600; font-size: 16px; color: var(--accent);">Label</div>
            <div id="ins-meta" style="font-size: 11px; opacity: 0.5; margin-top: 4px;">Line 0 | 0 Refs</div>
            <div class="math-preview" id="math-target"></div>
            <button class="btn" style="width: 100%; margin: 0;" onclick="document.getElementById('inspector').style.display='none'">Close</button>
        </div>
    </div>

    <script>
        let nodes, edges, network;

        function getTheme() {
            return {
                isDark: window.matchMedia('(prefers-color-scheme: dark)').matches,
                bg: getComputedStyle(document.documentElement).getPropertyValue('--bg').trim()
            };
        }

        const initialNodes = [
            { id: 's1', label: 'sec:intro', type: 'section', line: 1, refs: 2, content: '\\text{Introduction}' },
            { id: 'e1', label: 'eq:einstein', type: 'equation', line: 10, refs: 15, content: 'E = mc^2' },
            { id: 'e2', label: 'eq:newton', type: 'equation', line: 15, refs: 5, content: 'F = ma' },
            { id: 'f1', label: 'fig:data', type: 'figure', line: 40, refs: 1, content: '\\text{Figure: Data Analysis}' },
            { id: 's2', label: 'sec:theory', type: 'section', line: 5, refs: 8, content: '\\text{Theoretical Basis}' }
        ];

        const initialEdges = [
            { from: 'e1', to: 's2' },
            { from: 'e2', to: 's2' },
            { from: 'f1', to: 's1' },
            { from: 'e1', to: 'e2' }
        ];

        function formatNode(n) {
            const theme = getTheme();
            const colors = {
                section: getComputedStyle(document.documentElement).getPropertyValue('--node-sec'),
                equation: getComputedStyle(document.documentElement).getPropertyValue('--node-eq'),
                figure: getComputedStyle(document.documentElement).getPropertyValue('--node-fig')
            };
            const color = colors[n.type] || colors.equation;
            
            // Size: Small base (4) + log scale refs
            const size = 4 + (Math.log(n.refs + 1) * 5);
            
            return {
                id: n.id,
                label: n.label,
                shape: 'dot',
                size: size,
                color: { background: color, border: color, highlight: { background: color, border: theme.isDark ? '#fff' : '#000' } },
                font: { 
                    color: getComputedStyle(document.documentElement).getPropertyValue('--fg'),
                    size: 10,
                    face: 'Inter',
                    vadjust: -22, // Move text away from node
                    strokeWidth: 3, // Prevent overlap with edges
                    strokeColor: theme.bg 
                },
                borderWidth: 0,
                metadata: n
            };
        }

        function init() {
            nodes = new vis.DataSet(initialNodes.map(formatNode));
            edges = new vis.DataSet(initialEdges.map(e => ({
                ...e,
                arrows: { to: { enabled: true, scaleFactor: 0.3 } },
                color: { color: getComputedStyle(document.documentElement).getPropertyValue('--edge'), opacity: 0.6 },
                width: 1,
                smooth: false // Straight lines as requested
            })));

            const container = document.getElementById('viz');
            const options = {
                physics: {
                    enabled: true,
                    barnesHut: {
                        gravitationalConstant: -4000, // Stronger repulsion to avoid overlap
                        centralGravity: 0.3,
                        springLength: 120,
                        avoidOverlap: 1 // Force nodes to stay apart
                    },
                    stabilization: { iterations: 150 }
                },
                interaction: { hover: true, hideEdgesOnDrag: true }
            };

            network = new vis.Network(container, { nodes, edges }, options);

            network.on("click", (p) => {
                if (p.nodes.length > 0) {
                    const node = nodes.get(p.nodes[0]).metadata;
                    const ins = document.getElementById('inspector');
                    document.getElementById('ins-label').innerText = node.label;
                    document.getElementById('ins-meta').innerText = `Line ${node.line} | ${node.refs} References`;
                    const target = document.getElementById('math-target');
                    target.innerHTML = `\\[ ${node.content} \\]`;
                    ins.style.display = 'block';
                    if (window.MathJax) MathJax.typesetPromise([target]);
                } else {
                    document.getElementById('inspector').style.display = 'none';
                }
            });
        }

        let simCount = 0;
        function addDynamicNode() {
            simCount++;
            const id = 'sim' + simCount;
            const node = {
                id: id, label: 'eq:dynamic_' + simCount, type: 'equation',
                line: 100 + simCount, refs: Math.floor(Math.random() * 8),
                content: '\\mathcal{L} = \\bar{\\psi}(i\\gamma^\\mu D_\\mu - m)\\psi'
            };
            nodes.add(formatNode(node));
            edges.add({ from: id, to: 's2', arrows: { to: { enabled: true, scaleFactor: 0.3 } }, color: { opacity: 0.6 }, width: 1, smooth: false });
            network.focus(id, { scale: 1.2, animation: true });
        }

        window.onload = init;

        // Auto-refresh styles on theme change
        window.matchMedia('(prefers-color-scheme: dark)').addListener(() => {
            const theme = getTheme();
            nodes.forEach(n => {
                nodes.update({ 
                    id: n.id, 
                    font: { color: getComputedStyle(document.documentElement).getPropertyValue('--fg'), strokeColor: theme.bg } 
                });
            });
            edges.forEach(e => {
                edges.update({ id: e.id, color: { color: getComputedStyle(document.documentElement).getPropertyValue('--edge') } });
            });
        });
    </script>
</body>
</html>
